From 83db17ac129467dd571fa1caffd2d7b8f46e5e35 Mon Sep 17 00:00:00 2001
From: dianlujitao <dianlujitao@lineageos.org>
Date: Fri, 11 Jul 2025 16:06:11 +0800
Subject: [PATCH 03/15] init: add a hook before parsing system properties

Also properly implement weak symbol overridden while at it.

Change-Id: Id563c8aaa52c0e41823dbb035f0319a6531f12b7
---
 init/Android.bp           | 3 ++-
 init/property_service.cpp | 2 ++
 init/vendor_init.cpp      | 5 +++++
 init/vendor_init.h        | 3 ++-
 4 files changed, 11 insertions(+), 2 deletions(-)

diff --git a/init/Android.bp b/init/Android.bp
index f80e0f16b9..4691b1fe6b 100644
--- a/init/Android.bp
+++ b/init/Android.bp
@@ -84,6 +84,7 @@ init_device_sources = [
     "uevent_listener.cpp",
     "ueventd.cpp",
     "ueventd_parser.cpp",
+    "vendor_init.cpp",
 ]
 
 soong_config_module_type {
@@ -234,7 +235,7 @@ cc_defaults {
         "libcap",
     ] + select(soong_config_variable("libinit", "vendor_init_lib"), {
         any @ flag_val: [flag_val],
-        default: ["vendor_init"],
+        default: [],
     }),
     header_libs: ["bootimg_headers"],
     proto: {
diff --git a/init/property_service.cpp b/init/property_service.cpp
index 5f94ffae9c..854b3fee30 100644
--- a/init/property_service.cpp
+++ b/init/property_service.cpp
@@ -1443,6 +1443,8 @@ void PropertyInit() {
     ProcessKernelCmdline();
     ProcessBootconfig();
 
+    vendor_process_bootenv();
+
     // Propagate the kernel variables to internal variables
     // used by init as well as the current required properties.
     ExportKernelBootProps();
diff --git a/init/vendor_init.cpp b/init/vendor_init.cpp
index d3fd5ffe2b..fa104c8462 100644
--- a/init/vendor_init.cpp
+++ b/init/vendor_init.cpp
@@ -35,3 +35,8 @@ __attribute__ ((weak))
 void vendor_load_properties()
 {
 }
+
+__attribute__ ((weak))
+void vendor_process_bootenv()
+{
+}
diff --git a/init/vendor_init.h b/init/vendor_init.h
index 9afb449be0..8dc2bbaf7e 100644
--- a/init/vendor_init.h
+++ b/init/vendor_init.h
@@ -29,5 +29,6 @@ IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 
 #ifndef __INIT_VENDOR__H__
 #define __INIT_VENDOR__H__
-extern void vendor_load_properties(void);
+void vendor_load_properties();
+void vendor_process_bootenv();
 #endif /* __INIT_VENDOR__H__ */
-- 
2.39.5

