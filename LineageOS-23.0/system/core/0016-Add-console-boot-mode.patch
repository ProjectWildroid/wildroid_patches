From b382f2b9046efe50c7b8c7e59c12a9443587a5cf Mon Sep 17 00:00:00 2001
From: Yumi Yukimura <me.cafebabe@gmail.com>
Date: Wed, 23 Jul 2025 03:32:11 +0800
Subject: [PATCH 16/21] Add console boot mode

Change-Id: Id51f200ca2c5123cf16212c363d770f503744581
---
 init/init.cpp   | 2 ++
 rootdir/init.rc | 7 +++++++
 2 files changed, 9 insertions(+)

diff --git a/init/init.cpp b/init/init.cpp
index 23492b82b..868573c6f 100644
--- a/init/init.cpp
+++ b/init/init.cpp
@@ -1148,6 +1148,8 @@ int SecondStageMain(int argc, char** argv) {
     std::string bootmode = GetProperty("ro.bootmode", "");
     if (bootmode == "charger") {
         am.QueueEventTrigger("charger");
+    } else if (bootmode == "console") {
+        am.QueueEventTrigger("console");
     } else {
         am.QueueEventTrigger("late-init");
     }
diff --git a/rootdir/init.rc b/rootdir/init.rc
index a823f0ed4..cca1f4a4c 100644
--- a/rootdir/init.rc
+++ b/rootdir/init.rc
@@ -506,6 +506,13 @@ on init
     chmod 0770 /mnt/vm
     mkdir /mnt/vm/early 0770 system system
 
+on console
+    start console
+
+# Start the system when the user type `exit` on console
+on property:init.svc.console=restarting
+    trigger late-init
+
 # Run boringssl self test for each ABI.  Any failures trigger reboot to firmware.
 import /system/etc/init/hw/init.boringssl.${ro.zygote}.rc
 
-- 
2.47.3

