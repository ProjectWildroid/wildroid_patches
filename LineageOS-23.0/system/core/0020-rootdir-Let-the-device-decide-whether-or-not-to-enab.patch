From a64b1db4e18836aa0c7bdbca55290bd70fee42ec Mon Sep 17 00:00:00 2001
From: Yumi Yukimura <me.cafebabe@gmail.com>
Date: Thu, 24 Jul 2025 03:01:48 +0800
Subject: [PATCH 20/21] rootdir: Let the device decide whether or not to enable
 kernel module autoloading

Change-Id: Ib111ebfe90f7cb2ac8c7b2c6af48d81c2c0c2b2d
---
 rootdir/init.rc    | 5 +++++
 rootdir/ueventd.rc | 1 -
 2 files changed, 5 insertions(+), 1 deletion(-)

diff --git a/rootdir/init.rc b/rootdir/init.rc
index 5e44d46a6..a1bc873f6 100644
--- a/rootdir/init.rc
+++ b/rootdir/init.rc
@@ -16,6 +16,11 @@ on early-init-begin
     # Disable sysrq from keyboard
     write /proc/sys/kernel/sysrq 0
 
+    # Android doesn't need kernel module autoloading, and it causes SELinux
+    # denials.  So disable it by setting modprobe to the empty string.  Note: to
+    # explicitly set a sysctl to an empty string, a trailing newline is needed.
+    write /proc/sys/kernel/modprobe /vendor/bin/modprobe_wrapper
+
     # Set the security context of /adb_keys if present.
     restorecon /adb_keys
 
diff --git a/rootdir/ueventd.rc b/rootdir/ueventd.rc
index 2530d5fce..3927501a4 100644
--- a/rootdir/ueventd.rc
+++ b/rootdir/ueventd.rc
@@ -2,7 +2,6 @@ import /vendor/etc/ueventd.rc
 import /odm/etc/ueventd.rc
 
 firmware_directories /etc/firmware/ /odm/firmware/ /vendor/firmware/ /firmware/image/
-modalias_handling enabled
 uevent_socket_rcvbuf_size 16M
 
 subsystem graphics
-- 
2.47.3

