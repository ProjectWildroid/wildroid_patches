From a320d5c8ec76fdc3cecf27a0263bdb2273a52ee5 Mon Sep 17 00:00:00 2001
From: Yumi Yukimura <me.cafebabe@gmail.com>
Date: Tue, 5 Aug 2025 04:47:14 +0800
Subject: [PATCH 28/30] Wire up dmabuf_driver and gbm_mesa_driver

Change-Id: Id7c0b347bcb1041ce54065868517556c58047c48
---
 Android.bp                               | 26 ++++++++++++++++++--
 dmabuf_driver/dmabuf_external_driver.cpp |  4 ++++
 dmabuf_driver/dmabuf_internals.cpp       |  4 ++++
 drv.c                                    | 30 ++++++++++++++++++++++++
 gbm_mesa_driver/gbm_mesa_driver.cpp      |  4 ++++
 gbm_mesa_driver/gbm_mesa_internals.cpp   |  8 +++++++
 gbm_mesa_driver/gbm_mesa_wrapper.c       |  4 ++++
 7 files changed, 78 insertions(+), 2 deletions(-)

diff --git a/Android.bp b/Android.bp
index 33f369e..6e41cba 100644
--- a/Android.bp
+++ b/Android.bp
@@ -54,6 +54,21 @@ filegroup {
         "virtgpu_virgl.c",
         "vmwgfx.c",
         "xe.c",
+
+        "dmabuf_driver/dmabuf_external_driver.cpp",
+        "dmabuf_driver/dmabuf_internals.cpp",
+        "gbm_mesa_driver/gbm_mesa_driver.cpp",
+        "gbm_mesa_driver/gbm_mesa_internals.cpp",
+        "gbm_mesa_driver/gbm_mesa_wrapper.c",
+    ],
+}
+
+filegroup {
+    name: "gbm_files",
+
+    srcs: [
+        "gbm.c",
+        "gbm_helpers.c",
     ],
 }
 
@@ -91,6 +106,8 @@ generic_x86_cflags = arcvm_cflags + generic_cflags + intel_cflags + [
 ]
 
 generic_x86_cros_gralloc_cflags = [
+    "-DDRV_DMABUF_HEAP",
+    "-DDRV_GBM_MESA",
     "-DDRV_HBM_HELPER",
 ]
 
@@ -144,6 +161,11 @@ cc_defaults {
 
     defaults: ["minigbm_defaults"],
 
+    srcs: select(soong_config_variable("minigbm", "platform"), {
+        "generic_x86": [":gbm_files"],
+        default: [],
+    }),
+
     cflags: select(soong_config_variable("minigbm", "platform"), {
         "generic_x86": generic_x86_cros_gralloc_cflags,
         default: [],
@@ -201,8 +223,7 @@ cc_library {
 
     srcs: [
         ":minigbm_core_files",
-        "gbm.c",
-        "gbm_helpers.c",
+        ":gbm_files",
         "minigbm_helpers.c",
     ],
 
@@ -294,6 +315,7 @@ cc_library_headers {
 cc_library_shared {
     name: "libminigbm_gralloc_generic_x86",
     defaults: ["minigbm_cros_gralloc_library_defaults"],
+    srcs: [":gbm_files"],
     cflags: generic_x86_cflags + generic_x86_cros_gralloc_cflags,
 }
 
diff --git a/dmabuf_driver/dmabuf_external_driver.cpp b/dmabuf_driver/dmabuf_external_driver.cpp
index 52f5802..d18ec54 100644
--- a/dmabuf_driver/dmabuf_external_driver.cpp
+++ b/dmabuf_driver/dmabuf_external_driver.cpp
@@ -1,3 +1,5 @@
+#ifdef DRV_DMABUF_HEAP
+
 #include "dmabuf_internals.h"
 
 #include "drv_priv.h"
@@ -24,3 +26,5 @@ struct backend backend_dmabuf_heap = {
 #ifdef __cplusplus
 }
 #endif
+
+#endif
diff --git a/dmabuf_driver/dmabuf_internals.cpp b/dmabuf_driver/dmabuf_internals.cpp
index a7e68cf..43677b6 100644
--- a/dmabuf_driver/dmabuf_internals.cpp
+++ b/dmabuf_driver/dmabuf_internals.cpp
@@ -1,3 +1,5 @@
+#ifdef DRV_DMABUF_HEAP
+
 #define LOG_TAG "DMABUF-GRALLOC"
 
 extern "C" {
@@ -334,3 +336,5 @@ int dmabuf_bo_flush(struct bo *bo, struct mapping *mapping)
 
 	return 0;
 }
+
+#endif
diff --git a/drv.c b/drv.c
index 19a5507..bab5fb2 100644
--- a/drv.c
+++ b/drv.c
@@ -28,6 +28,13 @@
 #include "drv_priv.h"
 #include "util.h"
 
+#ifdef DRV_DMABUF_HEAP
+extern const struct backend backend_dmabuf_heap;
+#endif
+#ifdef DRV_GBM_MESA
+extern const struct backend backend_gbm_mesa;
+#endif
+
 #ifdef DRV_AMDGPU
 extern const struct backend backend_amdgpu;
 #endif
@@ -104,6 +111,29 @@ static const struct backend *drv_get_backend(int fd)
 	drmVersionPtr drm_version;
 	unsigned int i;
 
+#ifdef __ANDROID__
+	const char *prop_buf;
+	prop_buf = drv_get_os_option("vendor.minigbm.generic_backend");
+
+	if (prop_buf != NULL) {
+		if (!strcmp(prop_buf, "dmabuf_heap")) {
+#ifdef DRV_DMABUF_HEAP
+			return &backend_dmabuf_heap;
+#else
+			drv_loge("dmabuf_heap backend is not compiled in\n");
+#endif
+		}
+		if (!strcmp(prop_buf, "gbm_mesa")) {
+#ifdef DRV_GBM_MESA
+			return &backend_gbm_mesa;
+#else
+			drv_loge("gbm_mesa backend is not compiled in\n");
+#endif
+		}
+		drv_loge("Invalid generic backend specified\n");
+	}
+#endif
+
 	drm_version = drmGetVersion(fd);
 
 	if (!drm_version)
diff --git a/gbm_mesa_driver/gbm_mesa_driver.cpp b/gbm_mesa_driver/gbm_mesa_driver.cpp
index 9952c1d..8645013 100644
--- a/gbm_mesa_driver/gbm_mesa_driver.cpp
+++ b/gbm_mesa_driver/gbm_mesa_driver.cpp
@@ -14,6 +14,8 @@
  * limitations under the License.
  */
 
+#ifdef DRV_DMABUF_HEAP
+
 #include "gbm_mesa_internals.h"
 
 #include "drv_priv.h"
@@ -40,3 +42,5 @@ struct backend backend_gbm_mesa = {
 #ifdef __cplusplus
 }
 #endif
+
+#endif
diff --git a/gbm_mesa_driver/gbm_mesa_internals.cpp b/gbm_mesa_driver/gbm_mesa_internals.cpp
index d1eb457..f150fc9 100644
--- a/gbm_mesa_driver/gbm_mesa_internals.cpp
+++ b/gbm_mesa_driver/gbm_mesa_internals.cpp
@@ -14,6 +14,8 @@
  * limitations under the License.
  */
 
+#ifdef DRV_DMABUF_HEAP
+
 #define LOG_TAG "GBM-MESA-GRALLOC"
 
 extern "C" {
@@ -53,6 +55,10 @@ extern "C" {
 // PRIx64
 #include <inttypes.h>
 
+#ifdef __ANDROID__
+#define EMBEDDED_GBM_WRAPPER
+#endif
+
 #ifndef EMBEDDED_GBM_WRAPPER
 #define GBM_WRAPPER_NAME "libgbm_mesa_wrapper.so"
 #define GBM_GET_OPS_SYMBOL "get_gbm_ops"
@@ -593,3 +599,5 @@ uint32_t gbm_mesa_bo_get_map_stride(struct bo *bo)
 
 	return priv->map_stride;
 }
+
+#endif
diff --git a/gbm_mesa_driver/gbm_mesa_wrapper.c b/gbm_mesa_driver/gbm_mesa_wrapper.c
index 0c45bdd..df2720a 100644
--- a/gbm_mesa_driver/gbm_mesa_wrapper.c
+++ b/gbm_mesa_driver/gbm_mesa_wrapper.c
@@ -14,6 +14,8 @@
  * limitations under the License.
  */
 
+#ifdef DRV_DMABUF_HEAP
+
 #define LOG_TAG "GBM-MESA-WRAPPER"
 
 #include <gbm.h>
@@ -206,3 +208,5 @@ __attribute__((visibility("default"))) struct gbm_ops *get_gbm_ops()
 {
 	return &gbm_ops;
 }
+
+#endif
-- 
2.39.5

