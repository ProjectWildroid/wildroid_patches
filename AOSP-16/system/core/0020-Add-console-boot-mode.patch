From 8fe91fd96eb325d8f9c19ba4e62ea7b803e56fd7 Mon Sep 17 00:00:00 2001
From: Yumi Yukimura <me.cafebabe@gmail.com>
Date: Wed, 23 Jul 2025 03:32:11 +0800
Subject: [PATCH 20/22] Add console boot mode

Change-Id: Id51f200ca2c5123cf16212c363d770f503744581
---
 init/init.cpp   | 2 ++
 rootdir/init.rc | 7 +++++++
 2 files changed, 9 insertions(+)

diff --git a/init/init.cpp b/init/init.cpp
index 59cf15cf41..af148ae810 100644
--- a/init/init.cpp
+++ b/init/init.cpp
@@ -1142,6 +1142,8 @@ int SecondStageMain(int argc, char** argv) {
     std::string bootmode = GetProperty("ro.bootmode", "");
     if (bootmode == "charger") {
         am.QueueEventTrigger("charger");
+    } else if (bootmode == "console") {
+        am.QueueEventTrigger("console");
     } else {
         am.QueueEventTrigger("late-init");
     }
diff --git a/rootdir/init.rc b/rootdir/init.rc
index 2bb060728b..67a8676f7f 100644
--- a/rootdir/init.rc
+++ b/rootdir/init.rc
@@ -457,6 +457,13 @@ on init
     chmod 0770 /mnt/vm
     mkdir /mnt/vm/early 0770 system system
 
+on console
+    start console
+
+# Start the system when the user type `exit` on console
+on property:init.svc.console=restarting
+    trigger late-init
+
 # Run boringssl self test for each ABI.  Any failures trigger reboot to firmware.
 import /system/etc/init/hw/init.boringssl.${ro.zygote}.rc
 
-- 
2.39.5

