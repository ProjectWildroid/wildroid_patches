From ae6863d178c43110dbf67cc06a2b4fae2bfd4952 Mon Sep 17 00:00:00 2001
From: Yumi Yukimura <me.cafebabe@gmail.com>
Date: Sun, 6 Jul 2025 04:31:04 +0800
Subject: [PATCH 12/13] fs_mgr: Add fs_mgr option which ensures a list of paths
 must be accessible in mountpoint

Change-Id: I13dd240f184d2f6a962db169eed929de5d14bea4
---
 fs_mgr/fs_mgr.cpp                     | 14 ++++++++++++++
 fs_mgr/libfstab/fstab.cpp             |  2 ++
 fs_mgr/libfstab/include/fstab/fstab.h |  1 +
 3 files changed, 17 insertions(+)

diff --git a/fs_mgr/fs_mgr.cpp b/fs_mgr/fs_mgr.cpp
index 05706d8501..049bb551e7 100644
--- a/fs_mgr/fs_mgr.cpp
+++ b/fs_mgr/fs_mgr.cpp
@@ -883,6 +883,20 @@ static int __mount(const std::string& source, const std::string& target, const F
     if ((ret == 0) && (mountflags & MS_RDONLY) != 0) {
         fs_mgr_set_blk_ro(source);
     }
+    if ((ret == 0) && !entry.ensure_path_accessible.empty()) {
+        for (const auto& path : entry.ensure_path_accessible) {
+            if (access(std::string(target + "/"s + path).c_str(), F_OK) != 0) {
+                PERROR << "Path " << path << " is inaccessible in mount source " << source;
+                if (umount(target.c_str()) == 0) {
+                    ret = -1;
+                } else {
+                    PERROR << "Failed to unmount " << target
+                           << " due to specified path inaccessible";
+                }
+                break;
+            }
+        }
+    }
     if (ret == 0) {
         android::base::SetProperty("ro.boottime.init.mount." + Basename(target),
                                    std::to_string(t.duration().count()));
diff --git a/fs_mgr/libfstab/fstab.cpp b/fs_mgr/libfstab/fstab.cpp
index 06182d8880..43eab414ed 100644
--- a/fs_mgr/libfstab/fstab.cpp
+++ b/fs_mgr/libfstab/fstab.cpp
@@ -342,6 +342,8 @@ bool ParseFsMgrFlags(const std::string& flags, FstabEntry* entry) {
             }
         } else if (StartsWith(flag, "device=")) {
             ParseUserDevices(arg, entry);
+        } else if (StartsWith(flag, "ensure_path_accessible=")) {
+            entry->ensure_path_accessible = Split(arg, ";");
         } else {
             LWARNING << "Warning: unknown flag: " << flag;
         }
diff --git a/fs_mgr/libfstab/include/fstab/fstab.h b/fs_mgr/libfstab/include/fstab/fstab.h
index 4924ae3816..3c55712953 100644
--- a/fs_mgr/libfstab/include/fstab/fstab.h
+++ b/fs_mgr/libfstab/include/fstab/fstab.h
@@ -59,6 +59,7 @@ struct FstabEntry {
     std::string avb_keys;
     std::string lowerdir;
     std::string avb_hashtree_digest;
+    std::vector<std::string> ensure_path_accessible;
 
     struct FsMgrFlags {
         bool wait : 1;
-- 
2.39.5

