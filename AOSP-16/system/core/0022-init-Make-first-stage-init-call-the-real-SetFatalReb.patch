From 75f4e1441b657a8d69ae14a311a9ae3fdf9f4937 Mon Sep 17 00:00:00 2001
From: Yumi Yukimura <me.cafebabe@gmail.com>
Date: Wed, 23 Jul 2025 04:31:54 +0800
Subject: [PATCH 22/22] init: Make first stage init call the real
 SetFatalRebootTarget()

Change-Id: Ie62f6ce7783f4c1b19464a44b8cd58e09fcb2e7b
---
 init/host_init_stubs.h | 4 ++++
 init/reboot_utils.cpp  | 1 +
 init/util.cpp          | 1 +
 3 files changed, 6 insertions(+)

diff --git a/init/host_init_stubs.h b/init/host_init_stubs.h
index 2fef9d3498..f0f379fd61 100644
--- a/init/host_init_stubs.h
+++ b/init/host_init_stubs.h
@@ -46,7 +46,11 @@ inline bool CanReadProperty(const std::string&, const std::string&) {
 }
 
 // reboot_utils.h
+#if defined(USE_REAL_SET_FATAL_REBOOT_TARGET_FUNC)
+void SetFatalRebootTarget(const std::optional<std::string>& reboot_target = std::nullopt);
+#else
 inline void SetFatalRebootTarget(const std::optional<std::string>& = std::nullopt) {}
+#endif
 inline void __attribute__((noreturn)) InitFatalReboot(int signal_number) {
     abort();
 }
diff --git a/init/reboot_utils.cpp b/init/reboot_utils.cpp
index 32eb7e63cd..c8a7a6eea7 100644
--- a/init/reboot_utils.cpp
+++ b/init/reboot_utils.cpp
@@ -31,6 +31,7 @@
 #include <unwindstack/AndroidUnwinder.h>
 
 #include "capabilities.h"
+#define USE_REAL_SET_FATAL_REBOOT_TARGET_FUNC
 #include "reboot_utils.h"
 #include "util.h"
 
diff --git a/init/util.cpp b/init/util.cpp
index 375e905d50..ced6c08816 100644
--- a/init/util.cpp
+++ b/init/util.cpp
@@ -55,6 +55,7 @@
 #include "selabel.h"
 #include "selinux.h"
 #else
+#define USE_REAL_SET_FATAL_REBOOT_TARGET_FUNC
 #include "host_init_stubs.h"
 #endif
 
-- 
2.39.5

