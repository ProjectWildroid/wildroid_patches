From 85319ff787fc999a1a6ef8c52890f5ef80ca7c53 Mon Sep 17 00:00:00 2001
From: me-cafebabe <me.cafebabe@gmail.com>
Date: Mon, 20 Mar 2023 19:54:49 +0800
Subject: [PATCH] Add property to disable APCF extended features

* It's broken on some legacy devices, rendering Bluetooth crashing

Change-Id: I4b1764b7551150e78dd8e2dfc99a6472c1293c2b
---
 system/gd/hci/le_scanning_manager.cc | 6 +++++-
 1 file changed, 5 insertions(+), 1 deletion(-)

diff --git a/system/gd/hci/le_scanning_manager.cc b/system/gd/hci/le_scanning_manager.cc
index 439b6241c1..abc0ddf020 100644
--- a/system/gd/hci/le_scanning_manager.cc
+++ b/system/gd/hci/le_scanning_manager.cc
@@ -63,6 +63,8 @@ constexpr uint8_t kCodedPhyMask = 1 << 2;
 
 // system properties
 const std::string kLeRxPathLossCompProperty = "bluetooth.hardware.radio.le_rx_path_loss_comp_db";
+const std::string kPropertyDisableApcfExtendedFeatures = "bluetooth.le.disable_apcf_extended_features";
+bool kDisableApcfExtendedFeatures = false;
 
 const ModuleFactory LeScanningManager::Factory =
         ModuleFactory([]() { return new LeScanningManager(); });
@@ -193,7 +195,9 @@ struct LeScanningManager::impl : public LeAddressManagerCallback {
       api_type_ = ScanApiType::LEGACY;
     }
     is_filter_supported_ = controller_->IsSupported(OpCode::LE_ADV_FILTER);
-    if (is_filter_supported_) {
+    if (os::GetSystemProperty(kPropertyDisableApcfExtendedFeatures) == "1")
+      kDisableApcfExtendedFeatures = true;
+    if (is_filter_supported_ && !kDisableApcfExtendedFeatures) {
       le_scanning_interface_->EnqueueCommand(
               LeAdvFilterReadExtendedFeaturesBuilder::Create(),
               module_handler_->BindOnceOn(this, &impl::on_apcf_read_extended_features_complete));
-- 
2.39.5

