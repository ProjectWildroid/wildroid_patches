From b603ed1cd35c66fa904583aeaec57193bd476807 Mon Sep 17 00:00:00 2001
From: TheScarastic <warabhishek@gmail.com>
Date: Sat, 12 Sep 2020 17:28:03 +0000
Subject: [PATCH 6/7] Don't make recovery patch for devices with prebuilt
 vendor

Change-Id: I05c0155e6331bfeccd4ad545e003fa3fa3498044
---
 core/Makefile                             |  3 +++
 tools/releasetools/make_recovery_patch.py | 10 ++++++++--
 tools/releasetools/non_ab_ota.py          |  9 +++++++--
 3 files changed, 18 insertions(+), 4 deletions(-)

diff --git a/core/Makefile b/core/Makefile
index 1448572d46..d23ec7c732 100644
--- a/core/Makefile
+++ b/core/Makefile
@@ -5977,6 +5977,9 @@ endif
 ifeq ($(BOARD_USES_FULL_RECOVERY_IMAGE),true)
 	$(hide) echo "full_recovery_image=true" >> $@
 endif
+ifdef BUILDING_VENDOR_IMAGE
+	$(hide) echo "board_builds_vendorimage=true" >> $@
+endif
 ifdef BOARD_USES_VENDORIMAGE
 	$(hide) echo "board_uses_vendorimage=true" >> $@
 endif
diff --git a/tools/releasetools/make_recovery_patch.py b/tools/releasetools/make_recovery_patch.py
index 6be9417024..b52289b8a2 100644
--- a/tools/releasetools/make_recovery_patch.py
+++ b/tools/releasetools/make_recovery_patch.py
@@ -49,13 +49,19 @@ def main(argv):
 
   board_uses_vendorimage = OPTIONS.info_dict.get(
       "board_uses_vendorimage") == "true"
+  board_builds_vendorimage =  OPTIONS.info_dict.get(
+      "board_builds_vendorimage") == "true"
+  target_files_dir = None
 
-  if board_uses_vendorimage:
+  if board_builds_vendorimage:
     target_files_dir = "VENDOR"
-  else:
+  elif not board_uses_vendorimage:
     target_files_dir = "SYSTEM/vendor"
 
   def output_sink(fn, data):
+    if target_files_dir is None:
+      return
+
     with open(os.path.join(output_dir, target_files_dir,
                            *fn.split("/")), "wb") as f:
       f.write(data)
diff --git a/tools/releasetools/non_ab_ota.py b/tools/releasetools/non_ab_ota.py
index 667891c65e..66fa03c5cb 100644
--- a/tools/releasetools/non_ab_ota.py
+++ b/tools/releasetools/non_ab_ota.py
@@ -676,12 +676,17 @@ def _WriteRecoveryImageToBoot(script, output_zip):
 
 def HasRecoveryPatch(target_files_zip, info_dict):
   board_uses_vendorimage = info_dict.get("board_uses_vendorimage") == "true"
+  board_builds_vendorimage = info_dict.get("board_builds_vendorimage") == "true"
+  target_files_dir = None
 
-  if board_uses_vendorimage:
+  if board_builds_vendorimage:
     target_files_dir = "VENDOR"
-  else:
+  elif not board_uses_vendorimage:
     target_files_dir = "SYSTEM/vendor"
 
+  if target_files_dir is None:
+    return True
+
   patch = "%s/recovery-from-boot.p" % target_files_dir
   img = "%s/etc/recovery.img" % target_files_dir
 
-- 
2.39.5

